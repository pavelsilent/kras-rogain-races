<h3 class="header" *ngIf="format as raceFormat">
  <div class="header-container">
    <div class="race-name-container">
      <span>{{ raceFormat.raceName + ' / ' + raceFormat.name }}</span>
      <span>{{ (raceFormat.startDateTime | toRusDateTime) + ' / ' + raceFormat.state.name }}</span>
    </div>

    <div class="race-actions-container">
      <!--      <button *ngIf="raceFormat.state != states.STARTED && raceFormat.state != states.FINISHED"-->
      <button *ngIf="raceFormat.state != raceStates.STARTED && (page.canEdit() | async)"
              class="race-action"
              mat-flat-button
              color="primary"
              (click)="onSetRaceState(raceStates.STARTED)">Начать гонку
      </button>
      <button *ngIf="raceFormat.state == raceStates.STARTED && (page.canEdit() | async)"
              class="race-action"
              mat-flat-button
              color="primary"
              (click)="onSetRaceState(raceStates.STARTED)">Изменить<br>время начала
      </button>
      <button *ngIf="raceFormat.state == raceStates.STARTED && (page.canEdit() | async)"
              class="race-action"
              mat-flat-button
              color="primary"
              (click)="onSetRaceState(raceStates.FINISHED)">Завершить<br>гонку
      </button>
      <button *ngIf="!showAttitude" mat-flat-button color="primary"
              class="race-action"
              (click)="onToggleAttitudeProfileVisibility()">Показать<br>профиль высоты
      </button>
      <button *ngIf="showAttitude" mat-flat-button color="primary"
              class="race-action"
              (click)="onToggleAttitudeProfileVisibility()">Спрятать<br>профиль высоты
      </button>
      <button *ngIf="!showDistanceSchema" mat-flat-button color="primary"
              class="race-action"
              (click)="onToggleDistanceSchemaVisibility()">Показать<br>схему дистанции
      </button>
      <button *ngIf="showDistanceSchema" mat-flat-button color="primary"
              class="race-action"
              (click)="onToggleDistanceSchemaVisibility()">Спрятать<br>схему дистанции
      </button>

      <button *ngIf="localTime === 0" mat-flat-button color="primary"
              class="race-action"
              (click)="onToggleLocalTime()">Чистое время
      </button>
      <button *ngIf="localTime === 1" mat-flat-button color="primary"
              class="race-action"
              (click)="onToggleLocalTime()">Местное время
      </button>
      <button *ngIf="localTime === 2" mat-flat-button color="primary"
              class="race-action"
              (click)="onToggleLocalTime()">Местное<br>дата-время
      </button>
      <button *ngIf="localTime === 3" mat-flat-button color="primary"
              class="race-action"
              (click)="onToggleLocalTime()">Полное время
      </button>
    </div>
  </div>
</h3>

<div class="table-wrapper" *ngIf="format as raceFormat">
  <div *ngIf="showAttitude" class="img-container">
    <img *ngIf="attitudeProfile$ | async as attitudeProfileSrc"
         [src]="attitudeProfileSrc"
         (click)="openFullscreen($event)"
         alt="Профиль высоты"
         class="img">
  </div>
  <div *ngIf="showDistanceSchema" class="img-container">
    <img *ngIf="distanceSchema$ | async as distanceSchemaSrc"
         [src]="distanceSchemaSrc"
         (click)="openFullscreen($event)"
         alt="Схема дистанции"
         class="img">
  </div>
  <table mat-table [dataSource]="membersDataSource" class="protocol-table">
    <ng-container matColumnDef="name">
      <th mat-header-cell *matHeaderCellDef class="center bold">Участник</th>
      <td mat-cell *matCellDef="let row" (click)="onShowAthleteDetailInfo(row)"
          class="registered"
          [ngClass]="{'finished': row.isFinished(), 'disqualified': row.isDisqualified() }">
        <div class="athlete-data-container">
          <div class="athlete-data-time bold">
            <span class="athlete-data-name">{{ getShortFIO(row) }}
              <mat-icon *ngIf="page.canEdit() | async" (click)="$event.stopPropagation(); onAddAthleteCheckPoint(row)">add</mat-icon>
              <mat-icon *ngIf="page.canEdit() | async"
                        (click)="$event.stopPropagation(); onSetAthleteState(row)">edit</mat-icon>
            </span>
            <span>{{ 'Номер: ' + row.bibNumber }}</span>
          </div>
          <div class="athlete-data-time">
            <div>
                <span class="bold"
                      [ngClass]="{'check-time-expired': getCheckPointTimeExpired(row)}">
                  {{ getLastCheckPointTime(row, raceFormat.startDateTime!) }}
                </span>
              <br>
              <span style="font-style: italic; font-size: 11px">
                  {{ getLastCheckPoint(row) }}
                </span>
            </div>
            <div class="place-cell" *ngIf="row?.absolutePlace">
              <span>{{ 'Aбс: ' + row?.absolutePlace }}</span>
              <br>
              <span *ngFor="let group of row.groupPlaces" [ngStyle]="{'color': group.group.sex.color}">
                  {{ group.group.name + ': ' + group.place }}<br>
                </span>
            </div>
          </div>
        </div>
      </td>
    </ng-container>

    <tr mat-header-row *matHeaderRowDef="dataTableBodyDef" class="sticky-header"></tr>
    <tr mat-row *matRowDef="let row; columns: dataTableBodyDef;"></tr>
  </table>
</div>
